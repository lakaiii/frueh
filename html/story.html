<!DOCTYPE html>
<!-- vim: set wrap : -->
<html lang='en'>
  <head>
    <!-- 100% transparent gif --><link rel="icon" type="image/gif" sizes="16x16" href="data:image/gif;base64,R0lGODlhEAAQAIAAAAAAAAAAACH+BG5hZGEAIfkEAQoAAQAsAAAAABAAEABAAg6Mj6nL7Q+jnLTai7M+BQA7" />
    <meta charset='utf-8'>
    <title>ficdown</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/water.css@2/out/dark.min.css">
    <style>
      a.disabled {
        color: #999;
      }
      a.disabled.chosen {
        color: #88F;
      }
      a.disabled:hover {
        cursor: not-allowed;
      }
      h1, h2 { font-size: 100%; font-weight: normal;  }
      
      .hilight { animation: blink 1.5s ease-in-out 1;  }

      @keyframes blink {
          0% { background-color: transparent; }
          50% { background-color: yellow; }
          100% { background-color: transparent; }
      }
      
      @keyframes dreamin {
          0% { opacity: 0; }
          10% { opacity: 0.4; }
          90% { opacity: 0.4;}
          100% { opacity: 0; }
      }

      @keyframes dreamlow {
          0% { opacity: 0; }
          10% { opacity: 0.1; }
          90% { opacity: 0.1;}
          100% { opacity: 0; }
      }

      video { 
          animation: dreamlow 1s ease-in-out; 
      }

      #navi { opacity: 0.3; font-size: 80%; width: 100%; }
      #navi:hover { opacity: 0.8; }
      #navi a:link { text-decoration: none; }
      #game {
          padding: 0.2em; 
      }
      .invisible {
          display: none; 
      }
      .fixed {
          padding: 0.5em;
          position: absolute;
          width: 30vw;
          z-index: -100;
      }

      .hidden {
          visibility: hidden;
      }

    </style>
  </head>
  <body>
  <div id="game"></div>
  <div id="navi"></div>
  <div>
<script src="2.0.4/ficdown.min.js"></script>
    <script>

        function template(strings, ...keys) {
          return (function(...values) {
            let dict = values[values.length - 1] || {};
            let result = [strings[0]];
            keys.forEach(function(key, i) {
              let value = Number.isInteger(key) ? values[key] : dict[key];
              result.push(value, strings[i + 1]);
            });
            return result.join('');
          });
        }
        
        navItem=template`<a 
         onMouseOver="window.path[${0}].classList.add(&quot;hilight&quot;);" 
         onMouseOut="window.path[${0}].classList.remove(&quot;hilight&quot;);" 
         onClick="const a=window.path[${0}]; a.classList.remove(&quot;hilight&quot;);a.scrollIntoView();window.setTimeout(function() { a.classList.add(&quot;hilight&quot;) }, 200);"
         >${1}</a>`;

        fetch(document.location.hash.substr(1)+'?cache='+Date.now())
            .then( response => response.blob())
            .then( blob => blob.text())
            .then( function(txt) { 
                     const parts = txt.split("\n}\n\n");
                     var data = { 
                                    startText: "Los geht's....",
                                    endMarkdown: "\n# Ende\n\n[Nochmal?](restart())\n",
                                    title: "Geschichtentitel ",
                                    scroll: false
                                 };
                     var story;
                     if (parts.length == 1) {
                          story = parts[0];
                     } else {
                          story = parts[1];
                                 data = Object.assign(data, JSON.parse(parts[0]+"}"));
                     }
                     var player = new Ficdown({
                        id: "game",
                        source: story,
                        scroll: data.scroll,
                        startText: data.startText,
                        html: true,
                        endMarkdown: data.endMarkdown,
                        start: function() { 
                                    console.log("start");
                                    if (window.path.length > 1) {
                                                const last = window.path[window.path.length-1];
                                                window.path = [ last ];
                                                renderNavigation();
                                    };
                                document.body.classList.remove("play-finished")
                                },
                        finish: function() { console.log("finish"); document.body.classList.add("play-finished"); },
                      });
                    document.title = data.title;
                    player.play();
                    });

        window.path = [];

        function renderNavigation(param) {
                    let items = [];
                    window.path.forEach(function(i,e) { items.push(navItem(e,i.innerHTML)); });
                    document.getElementById("navi");
                    param = Object.assign( { prefix: "(", postfix: ")", separator: ") &middot; (" }, param);
                    navi.innerHTML = param.prefix + items.join(param.separator) + param.postfix;
        }

        document.getElementById("game").addEventListener("click", function(event) {
                    let p = window.path;
                    let t = event.target;
                    if ((t.tagName === "A") && (t.classList.length == 0)) {
                    p.push(event.target);
                    renderNavigation();
       } else {
                   console.log(`${t.tagName} ${t.classList}`);
       }
                }, useCapture=true);
       document.getElementById("game").addEventListener("animationend", function(event) {
                   const el = event.srcElement;
                   if (el.tagName == "VIDEO") {
                               el.classList.add("hidden");
                   }
                }, useCapture=true);
    </script>
  </body>
</html>
